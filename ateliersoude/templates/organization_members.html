{% extends 'organization_page.html' %}
{% load static bootstrap4 assets thumbnail initialavatar %}

{% block menu_content %}
  <section class="container position-sticky sticky-top" style="top:40px">
    <h2 class="text-center pt-4">{{ members.all.count }} membres</h2>
  </section>

  <section class="container card">
    <div class="col-lg bg-white">
        <form method="GET" class="form-row float-right">
            {% bootstrap_form search_form %}
          <div class="form-group p-2 mt-auto">
            <button type="submit" class="btn btn-primary btn-block">
              <span class="">Chercher un membre</span>
            </button>
        </form>
    </div>
    <div class="table-responsive">
      <table class="table infinite-container">
          <thead class="bg-primary">
            <tr>
              <th scope="col"><small class="text-white">Nom</small></th>
              <th scope="col"><small class="text-white">statut</small></th>
              <th scope="col"><small class="text-white">Cotisation</small></th>
              <th scope="col"></th>
            </tr>
          </thead>
          <tbody class="infinite-item">
            {% for user in members %}
            {% ifchanged %}
              <tr>
                <td colspan="4" class="bg-light">
                  <b>{{ user.last_name|make_list|first }}</b>
                </td>
              </tr>
            {% endifchanged %}
            <tr>
              <td>
                <a class="" href="{% url 'user:user_detail' user.pk %}">
                  {% if user.avatar_img %}
                    {% thumbnail user.avatar_img "30x30" crop="center" format="PNG" as im %}
                      <img src="{{ im.url }}" class="m-2 rounded-circle"/>
                    {% endthumbnail %}
                  {% else %}
                    {% if user.first_name %}
                      {% get_initial_avatar user 30 'circle' %}
                    {% endif %}
                  {% endif %}
                  <small>{{ user }}</small>
                </a>
              </td>
              <td>
                <small>
                  {% if user in organization.members.all %} Adhérent
                  {% elif user in organization.volunteers.all%} Volontaire
                  {% elif user in organization.actives.all%} Actif
                  {% elif user in organization.admins.all %}Administrateur
                  {% endif %}
                </small>
              </td>
              <td>
                <span class="badge badge-pill badge-success">
                  {% for membership in user.memberships.all %}
                    {% if membership.organization == organization %}
                      {{ membership.current_contribution }} €
                    {% endif%}
                  {% endfor %}
                </span>
              </td>
              <td>
                Mettre à jour
              </td>
            </tr>   
            {% endfor %}
          </tbody>
      </table>
    </div>
  </section>
  
  {% if page_obj.has_next %}
    <a class="infinite-more-link" href="?page={{ page_obj.next_page_number }}"></a>
  {% endif %}
{% endblock menu_content %}

{% block extra_js %}
  <script>
    $(document).ready(function(){
      $("#h_nav").sticky({topSpacing:40});
      $("#side_nav").sticky({topSpacing:80});
      $("#breadcrumb").sticky({topSpacing:0});
    });
  </script>
  {{  users|json_script:"users-data"}}
  <script src="{% static 'js/lib/jquery.waypoints.js' %}"></script>
  <script src="{% static 'js/lib/infinite.min.js' %}"></script>
  <script>
    var infinite = new Waypoint.Infinite({
      element: $('.infinite-container')[0],
      onBeforePageLoad: function () {
        $('.loading').show();
      },
      onAfterPageLoad: function ($items) {
        $('.loading').hide();
      }
    });
  </script>
  {% assets "js_detail_organization" %}
    <script src="{{ ASSET_URL }}"></script>
  {% endassets %}
{% endblock extra_js %}