{% extends 'base.html' %}
{% load assets app_filters thumbnail initialavatar %}

{% block extra_css %}
  {% assets "css_detail_user" %}
    <link type="text/css" href="{{ ASSET_URL }}" rel="stylesheet"/>
  {% endassets %}
{% endblock %}

{% block content %}
<div class="container-fluid">

  {% if request.user.pk == object.pk and not object.first_name or not object.last_name or not object.street_address %}
    <div class="alert alert-warning" role="alert">
      Pour devenir membre d'une organisation, vous devez renseigner votre Nom, Prénom 
      et Adresse postale.
    </div>
  {% endif %}

  {% url "user:user_list" as user_list_url %}
  {% include "breadcrumb.html" with current=object first_parent_url=user_list_url first_parent_text="Communauté" %}
  <div class="container">
    <div class="tab-content row no-gutters" id="v-pills-tabContent">
      <section class="header_detail_page p-0 text-center col-md-3">
          <div class="bg-grey" id="side_nav">
              <div class="pt-5 header_detail_page_picture badge-secondary">
                {% if object.avatar_img %}
                  {% thumbnail user.avatar_img "150x150" crop="center" format="PNG" as im %}
                    <img src="{{ im.url }}" class="m-2 rounded-circle"/>
                  {% endthumbnail %}
                {% else %}
                  {% if object.first_name %}
                    {% get_initial_avatar user 150 'circle' %}
                  {% endif %}
                {% endif %}
            <h2 class="pt-5 header_detail_page_title">{{ object }}</h2>
            {% if object.pk == request.user.pk %}
            <div class="rco">
              <a class="btn btn-primary" href="{% url "user:user_update" object.pk %}">
                <i class="fa fa-pencil-square-o 2-xs pt-1"></i>
                Editer mon profil
              </a>
              <a class="btn btn-warning" href="{% url "logout" %}">Deconnexion</a>
            </div>
          {% endif %}    
        </div> 
            <div class="nav flex-md-column flex-sm-row nav-pills justify-content-center p-4 text-left" role="tablist" aria-orientation="vertical">
                <a class="nav-link active" id="v-pills-info-tab" data-toggle="pill" href="#v-pills-info" role="tab" aria-controls="v-pills-info" aria-selected="false">Informations</a>
                <a class="nav-link" id="v-pills-rdv-tab" data-toggle="pill" href="#v-pills-rdv" role="tab" aria-controls="v-pills-rdv" aria-selected="true">Rendez-vous</a>
                <a class="nav-link" id="v-pills-membership-tab" data-toggle="pill" href="#v-pills-membership" role="tab" aria-controls="v-pills-membership" aria-selected="false">Adhésions</a>            </div>
          </div>
        </section>
        
  <section class="h-100 col-md-9 p-4">
    <div class="tab-content" id="v-pills-tabContent">
        <div class="">
            {% for organization in object.visitor_organizations.all %}
              <div class="card badge badge-pill badge-primary p-2">
                Visiteur de
                <a href="{% url 'organization_page' organization.slug %}">
                    {{ organization.name }}
                </a>
              </div>
              {% endfor %}
              {% for organization in object.member_organizations.all %}
              <span class="card badge badge-pill badge-primary p-2">
                Membre de
                <a href="{% url 'organization_page' organization.slug %}">
                    {{ organization.name }}
                </a>
              </span> 
              {% endfor %}
              {% for organization in object.volunteer_organizations.all %}
              <div class="card badge badge-pill badge-secondary p-2">
                  Membre actif de
                  <a href="{% url 'organization_page' organization.slug %}">
                      {{ organization.name }}
                  </a>
                </div> 
              {% endfor %}
              {% for organization in object.admin_organizations.all %}
              <div class="card badge badge-pill badge-secondary p-2">
                  Administrateur de 
                  <a href="{% url 'organization_page' organization.slug %}">
                      {{ organization.name }}
                  </a>
              </div> 
            {% endfor %}
  
            {% if not object.get_organizations %}
              <p>Ce profil n'est rattaché à aucune organisation</p>
            {% endif %}
        </div>
      <div class="tab-pane fade show active" id="v-pills-info" role="tabpanel" aria-labelledby="v-pills-info-tab">
      <h4 class="mt-4">Informations</h4>
      
      <div class="card p-4">
        <small><i>{{object.bio | safe}}</i></small>
      </div>

      <div class="card p-4">
          <div class="row">
            <div class="col-md-6 p-1">
              <i class="fa fa-phone pr-2"></i>Téléphone
            </div>
            <div class="col-md-6 p-1">
              {% if object.phone_number %}
                {{ object.phone_number }}
              {% else %}
                Non renseigné
              {% endif %}
            </div>
            <div class="col-md-6 p-1">
              <i class="fa fa-envelope pr-2"></i>Adresse mail
            </div>
            <div class="col-md-6 p-1">
              {% if object.email %}
              <a href="{{organization.email}}">{{ object.email }}</a>
              {% else %}
                Non renseigné
              {% endif %}
            </div>
            <div class="col-md-6 p-1">
              <i class="fa fa-map pr-2"></i>Adresse physique
            </div>
            <div class="col-md-6 p-1">
              {% if object.street_address %}
                {{ object.street_address }}
              {% else %}
                  Non renseigné
              {% endif %}
            </div>
            <div class="col-md-6 p-1">
                <i class="fa fa-birthday-cake pr-2"></i>Date d'anniversaire
            </div>
            <div class="col-md-6 p-1">
                <p class="mt-1">
                  {% if object.birth_date %}
                    {{ object.birth_date }}
                  {% else %}
                    Non renseigné
                  {% endif %}
                </p>
            </div>
            <div class="col-md-6 p-1">
                <span>Membre depuis</span>
            </div>
            <div class="col-md-6 p-1">
                <p class="mt-1">
                  le {{ object.date_joined|date:"d F Y" }}
                </p>
            </div>
          </div>
        </div>
    </div>

    {% if passed_rendezvous or future_rendezvous %}
    <div class="tab-pane fade show" id="v-pills-rdv" role="tabpanel" aria-labelledby="v-pills-rdv-tab">
        {% if future_rendezvous %}
          <h5 class="border-bottom border-gray pb-2"> {{ object.future_rendezvous.all.count}} Rendez-vous à venir</h5>
          <div class="row scrollable">
              <table class="table table-striped table-hover">
              {% for event, status in future_rendezvous %}
                <tr>
                  <th scope="col">
                  <a href="{% url 'event:detail' event.pk event.slug %}">
                    {{ event.activity.name }}
                  </a>
                  </th>
                  <td>
                    {{ event.date|date:"d F Y" }}
                  </td>
                  {% if status == "organizer" %}
                  <td>
                    <span class="badge badge-pill badge-success">Orga</span>
                  </td>
                  {% else %}
                    {% if object.pk == request.user.pk %}
                      {% tokenize user=object event=event action='cancel' as tok %}
                      <td>
                        <button class="btn btn-danger rounded-circle">
                          <a class="" href="{% url 'event:cancel_reservation' tok %}">
                            <i class="fa fa-times"></i>
                          </a>
                        </button>
                      </td>
                    {% endif %}
                  {% endif %}
                </tr>
              {% endfor %}
            </table>
          </div>
        {% endif %}
        <hr>

      <h5 class="border-bottom border-gray pb-2">Rendez-vous passés</h5>
        <div class="row scrollable">
            <table class="table table-striped table-hover">
            {% for event, status in passed_rendezvous %}
              <tr>
                <th scope="col">
                <a href="{% url 'event:detail' event.pk event.slug %}">
                  {{ event.activity.name }}
                </a>
                </th>
                <td>
                  {{ event.date|date:"d F Y" }}
                </td>
                <td>
                  {% if status == "organizer" %}
                    <span class="badge badge-pill badge-success">Orga</span>
                  {% elif status == "absent" %}
                    <span class="badge badge-pill badge-secondary">Absent</span>
                  {% elif status == "present" %}
                    <span class="badge badge-pill badge-info">A participé</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </table>
        </div>
      {% endif %}
      <hr>
    </div>


    <div class="tab-pane fade" id="v-pills-membership" role="tabpanel" aria-labelledby="v-pills-membership-tab">

      <h4 class="mt-4">Etat des cotisations</h4>
      <div class="card p-4">
      {% for membership in object.memberships.all %}
       {% if membership.organization in user.admin_organizations.all or user.volunteer_organizations.all  %}
        <h5 class="border-bottom border-gray pb-2">{{ membership.organization }}
        <small>depuis le {{ membership.first_payment|date:"d F Y" }}</small>
        <span class="badge badge-pill badge-success float-right">{{ membership.amount }}€</span></h5>
        <table class="table table-striped table-hover">

      {% for fee in object.fees.all %}
        {% if fee.organization == membership.organization %}
          <tr>
            <td>
            le {{ fee.date|date:"d F Y" }}
            </td>
            <td>
              Cotisation manuelle
            </td>
            <td>
              {{ fee.amount }}€
            </td>
          </tr>
          {% endif %}
        {% endfor %}
        
          {% for event, amount in passed_participations reversed %}
              {% if event.organization == membership.organization and amount != 0 %}
              <tr>
                <td>
                  le {{ event.date|date:"d F Y" }}
                </td>
                <td>
                  <a href="{% url 'event:detail' event.pk event.slug %}">{{event}}</a>
                </td>
                <td>
                  {{ amount }}€
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        </table>
      {% endif %}
      {% endfor %}
      </div>
    </div>
  </div>  
  </section>
</div>
</div>
</div>
{% endblock %}


{% block extra_js %}
<script>
  $(document).ready(function(){
    $("#side_nav").sticky({topSpacing:60});
    $("#breadcrumb").sticky({topSpacing:0});
  });
</script>
{% endblock %}

