{% extends 'list_view.html' %}

{% load staticfiles %}
{% load fontawesome %}
{% load avatar_tags %}
{% load django_bootstrap_breadcrumbs %}

{% block breadcrumbs %}
{% with type="place" view="place_list" %}
    {{ block.super }}
{% endwith %}
{% endblock %}


{% block title %} {{ block.super }} Places {% endblock title %}


{% block statistics %}

  {% with first_value=place_list.all.count first_label='places' second_value='' second_label='events' third_value='' third_label='?' %}
  {{block.super}}
  {% endwith %}

{% endblock statistics %}


{% block list %}

 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/>

  <script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js"
   integrity="sha512-tAGcCfR4Sc5ZP5ZoVz0quoZDYX5aCtEm/eu1KhSLj2c9eFrylXZknQYmxUssFaVJKvvc0dJQixhGjG2yXWiV9Q=="
   crossorigin=""></script>



<section class="">
  <div style="height:800px; width:800px" id="place_map"></div>
  <script>
    function popup_message(place){
        message = "<img src=\"" + place.picture + "\" width=\"60px\" style=\"float: left\"></img>"
        message += "<a href=\"" + place.place_detail_url + "\">" + place.name + "</a>"
        message += "<br> pour <a href=\"" + place.organization_url +"\">" + place.organization + "</a>"
        message += "<br> Type: " + place.type
        message += "<br> Description: " + place.description
        message += "<br> Adresse: " + place.address
        return message;
    }

    var places;
    var place_map = L.map('place_map').setView([45.735, 4.9], 12);

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox.streets',
        accessToken: 'pk.eyJ1IjoiYXRlbGllcnNvdWRlIiwiYSI6ImNqazEwZW16aDAzbDkza254cHhucHJtMncifQ.01v1DWXApDJmCySy4QvD4A'
    }).addTo(place_map);

    fetch('/api/getPlaces')
    .then(function(res){ return res.json(); })
    .then(function(data){
        places = data['places'];
        Object.entries(places).forEach(function([pk, place]){
                latitude = place.latitude;
                longitude = place.longitude;
                marker = L.marker([latitude,
                                        longitude]).addTo(place_map);

                marker.bindPopup(popup_message(place));
            });
    });

    </script>
</section>
{% endblock list %}
